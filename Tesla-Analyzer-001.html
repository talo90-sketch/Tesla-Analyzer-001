<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>محلل مستويات تسلا</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            padding: 30px 0;
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle {
            color: #a9a9b3;
            font-size: 1.1rem;
        }
        
        .input-section {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        label {
            font-weight: 600;
            color: #4ecdc4;
        }
        
        input, select {
            padding: 12px 15px;
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
            color: white;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #45b7d1;
            box-shadow: 0 0 0 3px rgba(69, 183, 209, 0.3);
        }
        
        button {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 107, 107, 0.4);
        }
        
        .results-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }
        
        .result-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .result-card h3 {
            color: #4ecdc4;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }
        
        .info-box {
            background: rgba(78, 205, 196, 0.1);
            border-left: 4px solid #4ecdc4;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 0 12px 12px 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        th, td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        th {
            color: #45b7d1;
            font-weight: 600;
        }
        
        tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }
        
        .tesla-highlight {
            color: #ff6b6b;
            font-weight: bold;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .results-section {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>محلل مستويات تسلا</h1>
            <p class="subtitle">تحليل المستويات الرقمية وتواريخ تسلا 3-6-9</p>
        </header>
        
        <div class="input-section">
            <div class="form-grid">
                <div class="form-group">
                    <label for="year">السنة المطلوبة</label>
                    <input type="number" id="year" placeholder="مثال: 2026" min="1900" max="2100" value="2026">
                </div>
                
                <div class="form-group">
                    <label for="price">السعر المرجعي</label>
                    <input type="number" id="price" placeholder="أدخل السعر" step="0.000001" value="1.2345">
                </div>
                
                <div class="form-group">
                    <label for="kind">نوع المرجع</label>
                    <select id="kind">
                        <option value="low">قاع (low)</option>
                        <option value="high">قمة (high)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="nLevels">عدد المستويات</label>
                    <input type="number" id="nLevels" placeholder="الافتراضي: 30" min="1" max="100" value="30">
                </div>
            </div>
            
            <div class="form-group">
                <label for="useLog">المقياس اللوغاريتمي</label>
                <select id="useLog">
                    <option value="false">لا</option>
                    <option value="true">نعم</option>
                </select>
            </div>
            
            <button onclick="analyzeTeslaLevels()">تحليل المستويات</button>
        </div>
        
        <div id="results" class="results-section hidden">
            <div class="result-card">
                <h3>معلومات التحليل</h3>
                <div class="info-box" id="analysisInfo"></div>
                <h3>المستويات</h3>
                <div style="overflow-x: auto;">
                    <table id="levelsTable">
                        <thead>
                            <tr>
                                <th>المستوى</th>
                                <th>السعر</th>
                                <th>المختزل</th>
                                <th>تسلا</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <div class="result-card">
                <h3>تواريخ تسلا</h3>
                <table id="datesTable">
                    <thead>
                        <tr>
                            <th>التاريخ</th>
                            <th>المختزل</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                
                <h3 style="margin-top: 30px;">التوافقات</h3>
                <table id="matchesTable">
                    <thead>
                        <tr>
                            <th>المستوى</th>
                            <th>السعر</th>
                            <th>المختزل</th>
                            <th>التواريخ</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        function reduceToSingleDigit(n) {
            if (n === 0) return 0;
            return n % 9 === 0 ? 9 : n % 9;
        }
        
        function reduceFloatLike(value) {
            const strValue = value.toString();
            const digits = strValue.split('').filter(char => char >= '0' && char <= '9');
            if (digits.length === 0) return 0;
            let total = digits.reduce((sum, digit) => sum + parseInt(digit), 0);
            while (total > 9) {
                total = total.toString().split('').reduce((sum, digit) => sum + parseInt(digit), 0);
            }
            return total;
        }
        
        function getDefaultGateAndStep(reduced) {
            let gate;
            if ([1, 4, 7].includes(reduced)) {
                gate = 12;
            } else if ([2, 5, 8].includes(reduced)) {
                gate = 15;
            } else {
                gate = 18;
            }
            return { gate_value: gate, section_step: gate / 4.0 };
        }
        
        function getTeslaDates(year) {
            const startDate = new Date(year, 0, 1);
            const endDate = new Date(year, 11, 31);
            const dates = [];
            
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dateStr = d.toISOString().split('T')[0];
                const ddmmyyyy = dateStr.replace(/-/g, '');
                const total = ddmmyyyy.split('').reduce((sum, digit) => sum + parseInt(digit), 0);
                const reduced = reduceToSingleDigit(total);
                if ([3, 6, 9].includes(reduced)) {
                    dates.push({ date: dateStr, reduced: reduced });
                }
            }
            return dates;
        }
        
        function generateLevels(price, kind, nLevels, useLog, step) {
            const levels = [];
            const basePrice = useLog ? Math.log10(price) : price;
            
            for (let i = 1; i <= nLevels; i++) {
                let levelPrice;
                if (useLog) {
                    const levelLog = kind === 'low' ? basePrice + i * step : basePrice - i * step;
                    levelPrice = Math.pow(10, levelLog);
                } else {
                    levelPrice = kind === 'low' ? price + i * step : price - i * step;
                }
                
                const reduced = reduceFloatLike(parseFloat(levelPrice.toFixed(10)));
                const isTesla = [3, 6, 9].includes(reduced);
                
                levels.push({
                    level: i,
                    price: parseFloat(levelPrice.toFixed(10)),
                    reduced: reduced,
                    isTesla: isTesla
                });
            }
            return levels;
        }
        
        function analyzeTeslaLevels() {
            const year = parseInt(document.getElementById('year').value);
            const price = parseFloat(document.getElementById('price').value);
            const kind = document.getElementById('kind').value;
            const nLevels = parseInt(document.getElementById('nLevels').value) || 30;
            const useLog = document.getElementById('useLog').value === 'true';
            
            if (!year || isNaN(price) || price <= 0) {
                alert('الرجاء إدخال قيم صحيحة');
                return;
            }
            
            const refReduced = reduceFloatLike(price);
            const gateConfig = getDefaultGateAndStep(refReduced);
            let step = gateConfig.section_step;
            
            if (useLog) {
                const decimalPlaces = price.toString().split('.')[1]?.length || 0;
                const adjustFactor = Math.pow(10, -(decimalPlaces - 2));
                step *= adjustFactor;
            }
            
            const levels = generateLevels(price, kind, nLevels, useLog, step);
            const teslaDates = getTeslaDates(year);
            
            // Group dates by reduced value
            const dateGroups = {};
            teslaDates.forEach(dateObj => {
                if (!dateGroups[dateObj.reduced]) {
                    dateGroups[dateObj.reduced] = [];
                }
                dateGroups[dateObj.reduced].push(dateObj.date);
            });
            
            // Find matches
            const matches = levels
                .filter(level => level.isTesla)
                .map(level => ({
                    level: level.level,
                    price: level.price,
                    reduced: level.reduced,
                    dates: dateGroups[level.reduced] || []
                }));
            
            // Display results
            displayResults(gateConfig.gate_value, step, levels, teslaDates, matches, year);
            document.getElementById('results').classList.remove('hidden');
        }
        
        function displayResults(gate, step, levels, dates, matches, year) {
            // Analysis info
            document.getElementById('analysisInfo').innerHTML = `
                <strong>البوابة الرقمية:</strong> ${gate}<br>
                <strong>خطوة القسم:</strong> ${step.toFixed(6)}
            `;
            
            // Levels table
            const levelsBody = document.querySelector('#levelsTable tbody');
            levelsBody.innerHTML = '';
            levels.forEach(level => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${level.level}</td>
                    <td>${level.price}</td>
                    <td>${level.reduced}</td>
                    <td>${level.isTesla ? '<span class="tesla-highlight">✓</span>' : ''}</td>
                `;
                levelsBody.appendChild(row);
            });
            
            // Dates table
            const datesBody = document.querySelector('#datesTable tbody');
            datesBody.innerHTML = '';
            dates.forEach(dateObj => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${dateObj.date}</td>
                    <td>${dateObj.reduced}</td>
                `;
                datesBody.appendChild(row);
            });
            
            // Matches table
            const matchesBody = document.querySelector('#matchesTable tbody');
            matchesBody.innerHTML = '';
            matches.forEach(match => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${match.level}</td>
                    <td>${match.price}</td>
                    <td>${match.reduced}</td>
                    <td>${match.dates.join(', ') || 'لا توجد تواريخ'}</td>
                `;
                matchesBody.appendChild(row);
            });
        }
    </script>
</body>
</html>

